<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Glass Patent Extractor</title>
    <script>
        function handleFileUpload(event, uploadURL) {
            // add to uploadURL the device type
            // const device = document.getElementById('device').value;
            // uploadURL += `_${device}`;

            event.preventDefault();
            const fileInput = document.getElementById('pdfFile');
            const file = fileInput.files[0];

            if (file) {
                const fileType = file.name.split('.').pop().toLowerCase();
                const isValidFile = fileType === 'pdf' || fileType === 'PDF' || file.type === 'application/pdf';

                if (!isValidFile) {
                    alert('Please upload a valid PDF file.');
                    return;
                }
                const formData = new FormData();
                formData.append('file', file);

                startLoading();

                fetch(uploadURL,
                    {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => poll_for_updates(data['task_id']))
                    .catch(error => {
                        console.error('Error:', error);
                        stopLoading();
                    });
            }
        }

        let polling = null;

        function poll_for_updates(task_id) {
            // poll for updates
            polling = setInterval(() => {
                check_status(task_id);
            }, 5000);
        }

        function check_status(taskId) {
            fetch(`/status/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    // console.log(data)
                    if (data['status'] === 'done' || data['status'] === 'failed') {
                        // stop polling
                        clearInterval(polling);
                        stopLoading();
                    }
                    if (data['status'] === 'done') {
                        // enable download buttons
                        enableButtons();
                        // display metadata
                        displayFileDetails(data['result']['metadata']);
                        // display glass configurations
                        displaySteps(data['result']['steps']);
                        displayClaims(data['result']['claims']);
                    } else if (data['status'] === 'failed') {
                        alert('Task failed', data['result']);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    stopLoading();
                });
        }

        function displayFileDetails(data) {
            const table = document.getElementById('metadata');
            table.innerHTML = `
                <tr>
                    <th>Attribute</th>
                    <th>Extracted Data</th>
                </tr>
                <tr>
                    <th>Publication Number</th>
                    <td>${data["hasDataResourceName"]}</td>
                </tr>
                <tr>
                    <th>Publication Date</th>
                    <td>${data["hasDataResourceDate"]}</td>
                </tr>
                <tr>
                    <th>Patent Title</th>
                    <td>${data["hasPatentTitle"]}</td>
                </tr>
                <tr>
                    <th>Applicant</th>
                    <td>${data["hasApplicant"]}</td>
                </tr>
                <tr>
                    <th>Inventor</th>
                    <td>${data["hasInventor"]}</td>
                </tr>
                <tr>
                    <th>Assignee</th>
                    <td>${data["hasInventor"]}</td>
                </tr>                
                <tr>
                    <th>Abstract</th>
                    <td>${data["hasAbstract"]}</td>
                </tr>
                <tr>
                    <th>IPC</th>
                    <td>${data["hasIPC"]}</td>
                </tr>
            `;
        }
        function displaySteps(data) {
            const table = document.getElementById('steps');
            // get all headers
            const headers = data.map((step, index) => {
                return Object.entries(step['setpoints'])
            });
            //  make that flat
            const flatHeaders = headers.flat()
            // [ [str, {}], ..]
            //make unique without losing values
            const uniqueHeaders = [...new Map(flatHeaders.map(item => [item[0], item])).values()]
            // console.log(uniqueHeaders)

            // create table headers
            // sort headers so columns with highest number of setpoints are on the left
            // uniqueHeaders.sort((a, b) => {
            //     return data.filter((step) => step['setpoints'][b]).length - data.filter((step) => step['setpoints'][a]).length;
            // })

            let header_str = `
                <tr>
                    <th>Glass</th>
            `;
            uniqueHeaders.forEach((header, ix) => {
                header_str += `
                    <th colspan="2" 
                    title="${header[1]['comment']}"
                    style=`
                if (header[1]['comment'] === "new") {
                    header_str += '"background-color: #ff0000 "'
                }
                else {
                    header_str += '"background-color: #f0f0f0 "'
                }
                header_str += `>${header[0]}</th>
                `;
                // add tooltip with description
            });
            header_str += `
                </tr>
            `;

            data.sort((a, b) => {
                return a['generatedObjectIdentifier'].localeCompare(b['generatedObjectIdentifier']);
            }).
                forEach((step, index) => {
                    header_str += `
                    <tr>
                        <th>${step['generatedObjectIdentifier']}</th>
                `;
                    uniqueHeaders.forEach((header) => {
                        header = header[0];
                        // if the header is not in the setpoints, add an empty cell
                        if (!step['setpoints'][header]) {
                            header_str += `
                            <td></td>
                            <td></td>
                        `;
                            return;
                        }
                        header_str += `
                        <td>${step['setpoints'][header]['value']}</td><td>
                    `;
                        // if the header unit not null
                        if (step['setpoints'][header]['unit'] && step['setpoints'][header]['unit'] !== 'null') {
                            header_str += `${step['setpoints'][header]['unit']}`;
                        }
                        header_str += `</td>`;
                    });
                    header_str += `
                    </tr>
                `;
                });
            table.innerHTML = header_str;
        }
        function displayClaims(data) {
            const div = document.getElementById('claims');
            let tables = "<tr><th>Compound</th><th>Amount</th></tr>"
            for (let i = 0; i < data.length; i++) {
                let s = ""
                // per table
                for (let j = 0; j < data[i].length; j++) {
                    s += `<tr><th>${data[i][j][0]}</th><td>${data[i][j][1]}</td></tr>`
                }
                if (i < data.length - 1)
                    s += "<tr><td></td><td></td></tr>"
                tables += s
            }
            div.innerHTML = tables;
        }

        function downloadCSV(tableType) {
            //download the table as csv
            const table = document.getElementById(tableType);
            // console.log(tableType, table)
            const rows = table.querySelectorAll('tr');
            const csv = [];
            // handle header separately because of colspan
            const headerRow = rows[0].querySelectorAll('th');
            const header = [];
            for (let i = 0; i < headerRow.length; i++) {
                header.push('"' + headerRow[i].innerText + '"');
                if (i > 0)
                    header.push('"' + headerRow[i].innerText + '"');
            }
            csv.push(header.join(','));
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i].querySelectorAll('td');
                if (row.length === 0 || !row[0].innerText) {
                    continue;
                }
                const rowArray = ['"' + rows[i].querySelectorAll('th')[0].innerText + '"'];
                for (let j = 0; j < row.length; j++) {
                    // if no content in the cell, add empty string
                    if (!row[j].innerText) {
                        rowArray.push('" "');
                        continue;
                    }
                    rowArray.push('"' + row[j].innerText + '"');
                }
                csv.push(rowArray.join(','));
            }
            const csvData = csv.join('\n');
            const blob = new Blob([csvData], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);

            const downloadButton = document.getElementById('downloadButton');
            downloadButton.onclick = () => {
                window.location.href = url;
            };
            downloadButton.click();
        }

        function downloadHTML(tableType) {
            // download glass configuration table as html
            const table = document.getElementById(tableType);
            const html = table.outerHTML;
            const blob = new Blob([html], { type: 'text/html' });
            const url = window.URL.createObjectURL(blob);

            const downloadButton = document.getElementById('downloadButton');
            downloadButton.onclick = () => {
                window.location.href = url;
            };
            downloadButton.click();

        }

        function enableButtons() {
            const buttons = document.querySelectorAll('button');
            buttons.forEach((button) => {
                button.disabled = false;
            });
            const fileInput = document.getElementById('pdfFile');
            const selectedFileName = document.getElementById('selectedFileName');
            selectedFileName.innerText = fileInput.files[0].name;
        }

        function startLoading() {
            document.getElementById('loader').classList.remove('hidden');
        }

        function stopLoading() {
            document.getElementById('loader').classList.add('hidden');
        }

        function toggleContent(id) {
            const content = document.getElementById(id);
            content.classList.toggle('expanded');

            // exchange first item of the header with another arrow
            const header = content.previousElementSibling;
            const arrow = header.querySelector('h2');
            arrow.innerText = arrow.innerText === '↓' ? '→' : '↓';
        }

        function toggleDropdown(id) {
            const dropdown = document.getElementById(id);
            dropdown.classList.toggle('block');
        }

        function handleKnowledgeUpdate(event) {
            event.preventDefault();
            const fileInput = document.getElementById('jsonFile');
            const file = fileInput.files[0];

            if (file) {
                const fileType = file.name.split('.').pop().toLowerCase();
                const isValidFile = fileType === 'json' || fileType === 'JSON';

                if (!isValidFile) {
                    alert('Please upload a valid JSON file.');
                    return;
                }
                const formData = new FormData();
                formData.append('file', file);

                startLoading();

                fetch('/update_knowledge',
                    {
                        method: 'POST',
                        body: formData
                    })
                    .then(response => response.json())
                    .then(data => {
                        // console.log(data);
                        stopLoading();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        stopLoading();
                    });
            }
        }

        function downloadKnowledgeBase() {
            fetch('/download_knowledge')
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'knowledge_base.json';
                    a.click();
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }
    </script>

    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f4f4f9;
            color: #333;
        }

        h1 {
            color: #0066cc;
        }

        form {
            margin-bottom: 20px;
        }

        label {
            font-weight: bold;
        }

        input[type="file"] {
            margin: 10px 0;
        }

        button {
            margin-right: 10px;
            padding: 8px 16px;
            background-color: #0066cc;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #005bb5;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        table,
        th,
        td {
            border: 1px solid #ccc;
        }

        th,
        td {
            padding: 10px;
            text-align: left;
        }

        th {
            background-color: #f0f0f0;
        }

        th:first-child,
        td:first-child {
            position: sticky;
            left: 0;
            background-color: #f0f0f0;
            /* Ensure background color to prevent overlapping issue */
            z-index: 1;
            /* Ensure the sticky column is above other cells */
        }

        .cancel {
            background-color: #ff0000;
        }

        /* Loader */
        .loader {
            border: 16px solid #f3f3f3;
            /* Light grey */
            border-top: 16px solid #3498db;
            /* Blue */
            border-radius: 50%;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 120px;
            height: 120px;
            animation: spin 2s linear infinite;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        .hidden {
            display: none;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Center the loader */
        .loader-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
        }

        .container {
            border: 1px solid #ccc;
            border-radius: 5px;
            overflow: hidden;
        }

        .content {
            height: 0;
            overflow: hidden;
            transition: height 0.3s ease-out;
            padding: 0 10px;
        }

        .content.expanded {
            height: auto;
            padding: 10px;
        }

        .expandable-header {
            display: flex;
            flex-direction: row;
            padding: 8px;
            gap: 8px;
            background-color: #f0f0f0;
            cursor: pointer;
        }

        /* The container <div> - needed to position the dropdown content */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        /* Dropdown Content (Hidden by Default) */
        .dropdown-content {
            display: none;
            position: absolute;
            background-color: #f9f9f9;
            min-width: 160px;
            box-shadow: 0px 8px 16px 0px rgba(0, 0, 0, 0.2);
            z-index: 1;
            /* padding between items */
        }

        /* Show the dropdown menu on hover */
        .dropdown:hover .dropdown-content {
            display: block;
        }


        .dropdown-content span {
            color: black;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
        }

        /* Change color of dropdown links on hover */
        .dropdown-content span:hover {
            background-color: #f1f1f1
        }
    </style>
</head>

<body>
    <div style="display: flex; flex-direction: column; gap: 1em;">
        <h1>Upload Patent PDF File</h1>
        <form id="uploadForm" onsubmit="handleFileUpload(event)" enctype="multipart/form-data">
            <button id="fileInputButton" onclick="document.getElementById('pdfFile').click()">&#8613; Upload PDF
                File</button>
            <label id="selectedFileName" for="pdfFile">No file selected</label>
            <input type="file" id="pdfFile" name="pdfFile" accept="application/pdf" style="display: none"
                onchange="enableButtons()">

            <button type="submit" onclick="handleFileUpload(event, '/single_pdf_async')" disabled>
                &#9654; Execute with existing Text
            </button>
            <button type="submit" onclick="handleFileUpload(event, '/single_pdf_ocr_async')" disabled>
                &#9654; Execute with OCR (GPU)
            </button>
        </form>

        <div style="display: flex; flex-direction: row; gap: 1em; justify-content: space-between;">
            <!-- button opens dropdown model -->
            <div>
                <div class="dropdown">
                    <button class="dropbtn">&#8615;Download as CSV</button>
                    <div class="dropdown-content">
                        <span onclick="downloadCSV('metadata')">Metadata</span>
                        <span onclick="downloadCSV('claims')">Claims</span>
                        <span onclick="downloadCSV('steps')">Configuration</span>
                    </div>
                </div>
                <div class="dropdown">
                    <button class="dropbtn">&#8615;Download as HTML</button>
                    <div class="dropdown-content">
                        <span onclick="downloadHTML('metadata')">Metadata</span>
                        <span onclick="downloadHTML('claims')">Claims</span>
                        <span onclick="downloadHTML('steps')">Configuration</span>
                    </div>
                </div>
                <button id="downloadButton" style="display: none;"></button>
            </div>
            <!-- button for knowledge update (json data)-->
            <div>
                <button id="jsonInputButton" onclick="document.getElementById('jsonFile').click()">
                    &#8613; Upload Knowledge Base
                </button>
                <input type="file" id="jsonFile" name="jsonFile" accept=".json" style="display: none" onchange="handleKnowledgeUpdate(event)">

                <button id="jsonDownloadButton" onclick="downloadKnowledgeBase()">
                    &#8615; Download Knowledge Base
                </button>
            </div>
        </div>

        <div id="mainContent" style="display: flex; flex-direction: column; gap: 1em;">
            <div class="container">
                <div class="expandable-header" onclick="toggleContent('expandableMetadata')">
                    <h2 style="display: inline-block; width: 1.5em;">↓</h2>
                    <h2>Metadata</h2>
                </div>
                <div class="content expanded" id="expandableMetadata">
                    <table id="metadata" border="1">
                        <tr>
                            <td>Not found</td>
                        </tr>
                        <!-- File details will be inserted here -->
                    </table>
                </div>
            </div>

            <div class="container">
                <div class="expandable-header" onclick="toggleContent('expandableClaims')">
                    <h2 style="display: inline-block; width: 1.5em;">↓</h2>
                    <h2>Claims</h2>
                </div>
                <div class="content expanded" id="expandableClaims">
                    <table id="claims" border="1">
                        <tr>
                            <td>Not found</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="container">
                <div class="expandable-header" onclick="toggleContent('expandableSteps')">
                    <h2 style="display: inline-block; width: 1.5em;">↓</h2>
                    <h2>Glass Configurations</h2>
                </div>
                <!-- scrollable container -->
                <div style="overflow-x:auto;" class="content expanded" id="expandableSteps">
                    <table id="steps" border="1">
                        <tr>
                            <td>Not found</td>
                        </tr>
                        <!-- File details will be inserted here -->
                    </table>
                </div>
            </div>
        </div>

        <div class="loader-container">
            <div class="loader hidden" id="loader"></div>
        </div>
    </div>
</body>

</html>